{% extends 'accounts/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
	body, html {
		height: 100%;
		margin: 0;
	}
	.dashboard {
		display: flex;
		height: 100vh;
	}
	/* Sidebar */
	.sidebar {
		width: 250px;
		background-color: #343a40;
		color: #fff;
		padding: 20px;
		position: fixed;
		top: 0;
		left: -260px; /* hidden by default */
		height: 100%;
		transition: left 0.3s ease;
		z-index: 1000;
	}
	.sidebar.show {
		left: 0; /* slide in */
	}
	.sidebar h4 {
		color: #f8f9fa;
		margin-bottom: 20px;
	}
	.sidebar .nav-link {
		color: #adb5bd;
		padding: 8px 0;
		display: block;
		text-decoration: none;
	}
	.sidebar .nav-link.active,
	.sidebar .nav-link:hover {
		color: #fff;
		font-weight: bold;
	}
	/* Main content */
	.main-content {
		flex-grow: 1;
		padding: 30px;
		background-color: #f1f3f6;
		overflow-y: auto;
		margin-left: 0;
		transition: margin-left 0.3s ease;
	}
	.main-content.shift {
		margin-left: 250px; /* shift when sidebar opens */
	}

	/* Toggle button */
	.toggle-sidebar-btn {
		position: fixed;
		top: 20px;
		left: 140px;
		z-index: 1100;
		background: #0984e3;
		color: #fff;
		border: none;
		padding: 8px 12px;
		border-radius: 5px;
		cursor: pointer;
	}

	.module-card {
		background: #fff;
		border-radius: 10px;
		padding: 20px;
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		margin-bottom: 20px;
	}
</style>

<div class="dashboard">
	<!-- Sidebar -->
	<div class="sidebar">
		<h4>Dashboard</h4>
		<ul class="nav flex-column" id="moduleTabs">
			<li><a class="nav-link active" href="#" data-target="home">Home</a></li>

			{% if user.role == "student" %}
				<li><a class="nav-link" href="#" data-target="concession">Apply for Concession</a></li>
				<li><a class="nav-link" href="#" data-target="current">Current Pass</a></li>
				<li><a class="nav-link" href="#" data-target="concessions">No. of Concessions Taken</a></li>
			{% elif user.role == "admin" %}
				<li><a class="nav-link" href="#" data-target="verify">Verify Concessions</a></li>
				<li><a class="nav-link" href="#" data-target="manage">Manage Students</a></li>
			{% elif user.role == "transporter" %}
				<li><a class="nav-link" href="#" data-target="issued">Issued Passes</a></li>
				<li><a class="nav-link" href="#" data-target="reports">Reports</a></li>
			{% endif %}
		</ul>
	</div>

	<!-- Main content -->
	<div class="main-content">
		<!-- Sidebar Toggle Button -->
		<button class="toggle-sidebar-btn" id="sidebarToggle">â˜° Menu</button>

		<div class="d-flex justify-content-between align-items-center mb-4">
			<a href="{% url 'logout' %}" class="btn btn-danger btn-sm">Logout</a>
		</div>

		<div id="moduleContent">
			<!-- Home -->
			<div class="module module-card" id="home" style="position: relative; padding:20px; min-height:300px;">
				<h2>Welcome, {{ user.username }} ðŸ‘‹</h2>
				<p class="text-muted">Use the sidebar to access your modules.</p>

				<!-- AI Assistant Toggle Button -->
				<button id="ai-toggle" style="
					position: absolute;
					top: 77px;
					right: 10px;
					background:#0984e3;
					color:white;
					border:none;
					border-radius:50%;
					width:55px;
					height:56px;
					font-size:31px;
					cursor:pointer;
				">ðŸ’¬</button>

				<!-- AI Chat Box -->
				<div id="ai-chat" style="
					display: none;
					position: absolute;
					top: 50px;
					right: 10px;
					width:250px;
					max-height:200px;
					background:white;
					border-radius:10px;
					box-shadow:0 4px 15px rgba(0,0,0,0.2);
					flex-direction: column;
					overflow: hidden;
					z-index: 10;
				">
					<div style="background:#0984e3; color:white; padding:8px; font-weight:bold;">Pass Mate Assistant</div>
					<div id="chat-messages" style="flex:1; padding:5px; overflow-y:auto;"></div>
					<div style="display:flex; border-top:1px solid #ccc;">
						<input id="chat-input" type="text" placeholder="Ask me..." style="flex:1; padding:5px; border:none;">
						<button id="send-btn" style="background:#0984e3; color:white; border:none; padding:5px 10px;">Send</button>
					</div>
				</div>
			</div>

			{% if user.role == "student" %}
				<!-- Apply for Concession -->
				<div class="module module-card d-none" id="concession">
					<h4 class="text-center">Apply for Concession</h4>
					{% if active_pass_exists %}
					<div class="alert alert-warning text-center">
						ðŸš¨ You already have an active pass. You cannot apply for another until it expires.
					</div>
					{% else %}
						{% include 'concession_form.html' %}
					{% endif %}
				</div>

				<!-- Current Pass -->
				<div class="module module-card d-none" id="current">
					<h4>Current Pass</h4>
					{% if active_pass_exists %}
						<a href="{% url 'show_pass' %}" class="btn btn-success w-100">View My E-Pass</a>
					{% else %}
						<button class="btn btn-secondary w-100" disabled>No Active Pass Available</button>
					{% endif %}

				</div>

				<!-- Concessions Taken -->
				<div class="module module-card d-none" id="concessions">
					<h4>No. of Concessions Taken</h4>
					<p>Total concessions taken: {{ concessions_taken }}</p>

					{% if concessions_list %}
					<div class="row mt-4">
						{% for concession in concessions_list %}
						<div class="col-md-6 mb-3">
							<div class="card p-3 shadow-sm {% if concession.is_active == 0 %}bg-light{% else %}bg-white{% endif %}" style="border-radius: 12px;">
								<strong>Name:</strong> {{ concession.s_name }}<br>
								<strong>Department:</strong> {{ concession.department }}<br>
								<strong>Destination:</strong> {{ concession.destination }}<br>
								<strong>Duration:</strong> {{ concession.duration }} month(s)<br>
								<strong>Status:</strong> {{ concession.status }}<br>
								<strong>Applied On:</strong> {{ concession.b_date }}<br>
							</div>
						</div>
						{% endfor %}
					</div>
					{% else %}
					<div class="mt-4 card p-3 shadow-sm" style="border-radius: 12px;">No concession applications found.</div>
					{% endif %}
				</div>
			{% elif user.role == "admin" %}
				<!-- Verify Concessions start-->
				<div class="module module-card d-none" id="verify">
					<h4>Verify Concessions</h4>

					{% if pending_concessions %}
					<table class="table table-striped table-bordered mt-3">
						<thead class="table-dark">
							<tr>
								<th>Student Name</th>
								<th>Department</th>
								<th>Destination</th>
								<th>Duration</th>
								<th>Applied On</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for concession in pending_concessions %}
							<tr>
								<td>{{ concession.s_name }}</td>
								<td>{{ concession.department }}</td>
								<td>{{ concession.destination }}</td>
								<td>{{ concession.duration }} month(s)</td>
								<td>{{ concession.b_date }}</td>
								<td>
									<form method="post" action="{% url 'approve_concession' concession.id %}" style="display:inline;">
										{% csrf_token %}
										<button type="submit" class="btn btn-success btn-sm">Approve</button>
									</form>
									<form method="post" action="{% url 'reject_concession' concession.id %}" style="display:inline;">
										{% csrf_token %}
										<button type="submit" class="btn btn-danger btn-sm">Reject</button>
									</form>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
					{% else %}
					<div class="alert alert-info mt-3">âœ… No pending concessions right now.</div>
					{% endif %}
				</div>
				<!-- Verify Concessions end-->
			{% elif user.role == "transporter" %}
				<!-- Issued Passes -->
				<div class="module module-card d-none" id="issued">
					<h4>Issued Passes</h4>
					<p>Transporter can view all issued passes.</p>
				</div>
				<!-- Reports -->
				<div class="module module-card d-none" id="reports">
					<h4>Reports</h4>
					<p>Generate and download reports here.</p>
				</div>
			{% endif %}
		</div>
	</div>
</div>

<script>
	// Sidebar toggle
	const sidebar = document.querySelector('.sidebar');
	const mainContent = document.querySelector('.main-content');
	const sidebarToggle = document.getElementById('sidebarToggle');

	sidebarToggle.addEventListener('click', () => {
		sidebar.classList.toggle('show');
		mainContent.classList.toggle('shift');
	});

	// Module switching
	const links = document.querySelectorAll('#moduleTabs .nav-link');
	const modules = document.querySelectorAll('#moduleContent .module');

	links.forEach(link => {
		link.addEventListener('click', function(e) {
			e.preventDefault();
			links.forEach(l => l.classList.remove('active'));
			this.classList.add('active');

			modules.forEach(m => m.classList.add('d-none'));
			const target = this.dataset.target;
			const targetDiv = document.getElementById(target);
			if (targetDiv) {
				targetDiv.classList.remove('d-none');
			}
		});
	});

	// AI Assistant
	const aiToggle = document.getElementById('ai-toggle');
	const aiChat = document.getElementById('ai-chat');
	const chatMessages = document.getElementById('chat-messages');
	const chatInput = document.getElementById('chat-input');
	const sendBtn = document.getElementById('send-btn');

	aiToggle.addEventListener('click', () => {
		aiChat.style.display = aiChat.style.display === 'none' ? 'flex' : 'none';
	});

	sendBtn.addEventListener('click', () => {
		const msg = chatInput.value.trim();
		if(!msg) return;

		const userMsg = document.createElement('div');
		userMsg.textContent = "You: " + msg;
		userMsg.style.textAlign = "right";
		userMsg.style.marginBottom = "3px";
		chatMessages.appendChild(userMsg);
		chatInput.value = "";

		let reply = "";
		if(msg.toLowerCase().includes("concession")){
			reply = "Click on 'Concession History' or 'Apply New Concession'. Then fill The form.";
		} else if(msg.toLowerCase().includes("pass")){
			reply = "Your pass info is visible on the dashboard cards.";
		} else {
			reply = "I can help! Ask about concessions, pass details, or dashboard features.";
		}

		const botMsg = document.createElement('div');
		botMsg.textContent = "Assistant: " + reply;
		botMsg.style.textAlign = "left";
		botMsg.style.fontStyle = "italic";
		botMsg.style.marginBottom = "3px";
		chatMessages.appendChild(botMsg);

		chatMessages.scrollTop = chatMessages.scrollHeight;
	});
</script>
{% endblock %}
