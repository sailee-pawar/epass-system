{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
	body, html {
		height: 100%;
		margin: 0;
		background: url('/static/images/dashboard-bg.jpg') no-repeat center center fixed;
		background-size: cover;
		font-family: Arial, sans-serif;
	}

	.dashboard {
		padding: 30px;
		min-height: 100vh;
		border-radius: 12px;
		/* remove the transparent background */
	}
	/* Navigation Cards */
	.nav-cards {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 20px;
		margin-bottom: 30px;
	}
	.nav-card {
		background: rgba(255, 255, 255, 0.9);
		border-radius: 12px;
		padding: 20px;
		text-align: center;
		box-shadow: 0 3px 6px rgba(0,0,0,0.1);
		cursor: pointer;
		transition: transform 0.2s, box-shadow 0.2s;
	}
	.nav-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 6px 12px rgba(0,0,0,0.15);
		background: #e6f0ff; /* light blue */
	}
	.nav-card.active {
		border: 2px solid #0984e3;
	}

	.module-card {
		background: rgba(255, 255, 255, 0.95);
		border-radius: 12px;
		padding: 20px;
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		margin-bottom: 20px;
	}
</style>

<!-- Toast Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
  {% if messages %}
    {% for message in messages %}
      <div class="toast align-items-center text-bg-success border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            {{ message }}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

<div class="dashboard">
	<div class="d-flex justify-content-between align-items-center mb-4" style="color:lavender; padding:10px; border-radius:8px;">
		<h2>Welcome, {{ user.username }} to Pass-Mate üëã</h2>
		<a href="{% url 'logout' %}" class="btn btn-danger btn-sm">Logout</a>
	</div>

	<!-- Navigation Cards -->
	<div class="nav-cards" id="moduleTabs">
		<a href="{% url 'dashboard' %}" class="nav-card {% if active == 'home' %}active{% endif %}">üè† Home</a>

		{% if user.role == "student" %}
			<a href="{% url 'dashboard' %}?active=concession" class="nav-card {% if active == 'concession' %}active{% endif %}">üìù Apply for Concession</a>
			<a href="{% url 'dashboard' %}?active=current_pass" class="nav-card {% if active == 'current_pass' %}active{% endif %}">üéü Current Pass</a>
			<a href="{% url 'dashboard' %}?active=concession_history" class="nav-card {% if active == 'concessions' %}active{% endif %}">üìä Concession History</a>

		{% elif user.role == "admin" %}
			<a href="{% url 'dashboard' %}?active=verify" class="nav-card {% if active == 'verify' %}active{% endif %}">‚úÖ Verify Concessions</a>
			<a href="{% url 'dashboard' %}?active=manage" class="nav-card {% if active == 'manage' %}active{% endif %}">üë• Manage Students</a>
			<a href="{% url 'dashboard' %}?active=profile" class="nav-card {% if active == 'profile' %}active{% endif %}">üè´ College Profile</a>

		{% elif user.role == "transporter" %}
			<a href="{% url 'dashboard' %}?active=pending" class="nav-card {% if active == 'pending' %}active{% endif %}">‚è≥ Pending Passes</a>
			<a href="{% url 'dashboard' %}?active=issued" class="nav-card {% if active == 'issued' %}active{% endif %}">üéü Issued Passes</a>
		{% endif %}
	</div>

	<!-- Module Content -->
	<div id="moduleContent">
		{% if user.role == "student" %}
			<!-- Home -->
			<div class="module module-card {% if active != 'home' %}d-none{% endif %}" id="home">
				<h4 class="text-center">Concession Status This Year</h4>
				<canvas id="concessionPieChart"
					data-pending="{{ pending_conc_count|default:0 }}"
					data-rejected="{{ rejected_conc_count|default:0 }}"
					data-approved="{{ approved_conc_count|default:0 }}"
					style="max-width:400px; margin:auto;">
				</canvas>
			</div>

			<!-- Chart.js library -->
			<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

			<!-- Your custom JS -->
			<script src="{% static 'accounts/concession_chart.js' %}"></script>
			</div>
			<div class="module module-card {% if active != 'concession' %}d-none{% endif %}" id="concession">
				<h4 class="text-center">Apply for Concession</h4>
				{% if active_pass_exists %}
					<div class="alert alert-warning text-center">üö® You already have an active pass.</div>
				{% elif pending_exists %}
  					<div class="alert alert-warning">‚è≥ Your concession application is pending.</div>
				{% else %}
					{% include 'concession_form.html' %}
				{% endif %}
			</div>

			<div class="module module-card {% if active != 'current_pass' %}d-none{% endif %}" id="current_pass">
				<h4>Current Pass</h4>
				{% if active_pass_exists %}
					<a href="{% url 'show_pass' %}" class="btn btn-success w-100">View My E-Pass</a>
				{% else %}
					<button class="btn btn-secondary w-100" disabled>No Active Pass</button>
				{% endif %}
			</div>

			<div class="module module-card {% if active != 'concession_history' %}d-none{% endif %}" id="concession_history">
				<h4>Concession History</h4>
				<p>Total concessions: {{ concessions_taken }}</p>
				{% if concessions_list %}
					<div class="row mt-4">
						{% for concession in concessions_list %}
							<div class="col-md-6 mb-3">
								<div class="card p-3 shadow-sm {% if concession.is_active == 0 %}bg-light{% else %}bg-white{% endif %}" style="border-radius: 12px;">
									<strong>Name:</strong> {{ concession.s_name }}<br>
									<strong>Department:</strong> {{ concession.department }}<br>
									<strong>Destination:</strong> {{ concession.destination }}<br>
									<strong>Duration:</strong> {{ concession.duration }} month(s)<br>
									<strong>Status:</strong> {{ concession.status }}<br>
									<strong>Applied On:</strong> {{ concession.created_at }}<br>
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}
					<div class="mt-4 card p-3 shadow-sm" style="border-radius: 12px;">No concession applications found.</div>
				{% endif %}
			</div>
		{% elif user.role == "admin" %}
			{% if active == "home" %}
				<div class="module module-card">
					<h4>Dashboard Overview</h4>
					<p class="text-muted">Welcome {{ user.username }}! Choose a task above.</p>
				</div>
			{% elif active == "verify" %}
				<div class="module module-card">
				<h4>Verify Concessions</h4>
				{% if pending_concessions %}
					<table class="table table-striped table-bordered mt-3">
						<thead class="table-dark">
							<tr>
								<th>Student</th>
								<th>Department</th>
								<th>Destination</th>
								<th>Duration</th>
								<th>Applied On</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for concession in pending_concessions %}
								<tr>
									<td>{{ concession.s_name }}</td>
									<td>{{ concession.department }}</td>
									<td>{{ concession.destination }}</td>
									<td>{{ concession.duration }} month(s)</td>
									<td>{{ concession.created_at }}</td>
									<td>
										<form method="post" action="{% url 'approve_concession' concession.id %}" style="display:inline;">
											{% csrf_token %}
											{% if concession.status == "Approved" %}
												<span data-bs-toggle="tooltip" data-bs-placement="top" title="Already Approved">
													<button type="button" class="btn btn-success btn-sm" disabled>Approve</button>
												</span>
											{% else %}
												<button type="submit" class="btn btn-success btn-sm">Approve</button>
											{% endif %}
										</form>
										<form method="post" action="{% url 'reject_concession' concession.id %}" style="display:inline;">
											{% csrf_token %}
											<button type="submit" class="btn btn-danger btn-sm">Reject</button>
										</form>
										<form method="post" action="{% url 'verify_concession' concession.id %}" style="display:inline;">
											{% csrf_token %}
											{% if concession.status != "Pending" %}
												<span data-bs-toggle="tooltip" data-bs-placement="top" title="Already Verified">
													<button type="button" class="btn btn-warning btn-sm" disabled>Verify</button>
												</span>
											{% else %}
												<button type="submit" class="btn btn-warning btn-sm">Verify</button>
											{% endif %}
										</form>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% else %}
					<div class="alert alert-info mt-3">‚úÖ No pending concessions.</div>
				{% endif %}
			</div>
			{% elif active == "manage" %}
				<div class="module module-card">
					<h4>Manage Students</h4>
					<p>Here you can manage students.</p>
				</div>
			{% elif active == "profile" %}
				<div class="module module-card">
					{% include "college_profile.html" %}
				</div>
			{% endif %}

		{% elif user.role == "transporter" %}

			<!-- Top KPI Cards -->
			 {% if active == "home" %}
				<div class="kpi-cards" style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px;">
					<div class="card kpi-card" style="flex:1; background:#FF7043; color:white; padding:15px; border-radius:8px; text-align:center; transition: transform 0.2s, box-shadow 0.2s;">
					<h4>Total Pending</h4>
					<p style="font-size:24px; font-weight:bold;">{{ pending_passes|length|default:0 }}</p>
					</div>
					<div class="card kpi-card" style="flex:1; background:#66BB6A; color:white; padding:15px; border-radius:8px; text-align:center; transition: transform 0.2s, box-shadow 0.2s;">
					<h4>Total Issued</h4>
					<p style="font-size:24px; font-weight:bold;">{{ issued_passes|length|default:0 }}</p>
					</div>
					<div class="card kpi-card" style="flex:1; background:#42A5F5; color:white; padding:15px; border-radius:8px; text-align:center; transition: transform 0.2s, box-shadow 0.2s;">
					<h4>Approved Today</h4>
					<p style="font-size:24px; font-weight:bold;">{{ approved_today|default:0 }}</p>
					</div>
					<div class="card kpi-card" style="flex:1; background:#AB47BC; color:white; padding:15px; border-radius:8px; text-align:center; transition: transform 0.2s, box-shadow 0.2s;">
					<h4>Top College Requests</h4>
					<p style="font-size:24px; font-weight:bold;">{{ top_college_name|default:"N/A" }}</p>
					</div>
				</div>

				<style>
					/* Hover effect for KPI cards */
					.kpi-card:hover {
					transform: translateY(-5px);
					box-shadow: 0 8px 20px rgba(0,0,0,0.2);
					cursor: pointer;
					}
				</style>
			{% endif %}

			{% if active == "pending" %}
				<div class="module module-card">
				{% include "pending_passes.html" %}
			</div>
			{% elif active == "issued" %}
				<div class="module module-card">
				{% include "issued_passes.html" %}
			</div>
			
			{% else %}
				<div class="module module-card d-flex justify-content-center align-items-center" style="min-height: 500px;">
    <iframe 
        src="{% url 'passes_chart' %}" 
        style="width:100%; max-width:500px; height:450px; border:none;">
    </iframe>
</div>


			{% endif %}
		{% endif %}
	</div>

	<!-- AI Assistant (GLOBAL, outside modules) -->
	<button id="ai-toggle" style="
		position: fixed;
		bottom: 20px;
		right: 20px;
		background:#0984e3;
		color:white;
		border:none;
		border-radius:50%;
		width:55px;
		height:56px;
		font-size:31px;
		cursor:pointer;
		z-index: 11;
	">üí¨</button>

	<div id="ai-chat" style="
		display: none;
		position: fixed;
		bottom: 80px;
		right: 20px;
		width:280px;
		max-height:350px;
		background:white;
		border-radius:10px;
		box-shadow:0 4px 15px rgba(0,0,0,0.2);
		flex-direction: column;
		overflow: hidden;
		z-index: 10;
	">
		<div style="background:#0984e3; color:white; padding:8px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
			Pass Mate Assistant
			<button id="ai-close" style="background:transparent; border:none; color:white; font-size:18px; cursor:pointer;">&times;</button>
		</div>
		<div id="chat-messages" style="flex:1; padding:5px; overflow-y:auto;"></div>
		<div style="display:flex; border-top:1px solid #ccc;">
			<input id="chat-input" type="text" placeholder="Ask me..." style="flex:1; padding:5px; border:none;">
			<button id="send-btn" style="background:#0984e3; color:white; border:none; padding:5px 10px;">Send</button>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
<script src="{% static 'accounts/session_check.js' %}"></script>

{% if user.role == "student" %}
<script>
	document.addEventListener("DOMContentLoaded", () => {
		const navCards = document.querySelectorAll('#moduleTabs .nav-card[data-target]');
	const modules = document.querySelectorAll('#moduleContent .module');

	navCards.forEach(card => {
		card.addEventListener('click', () => {
			navCards.forEach(c => c.classList.remove('active'));
			card.classList.add('active');

			modules.forEach(m => m.classList.add('d-none'));
			const targetDiv = document.getElementById(card.dataset.target);
			if (targetDiv) {
				targetDiv.classList.remove('d-none');
			}
		});
	});
	});
</script>
{% endif %}
<script>
	// AI Assistant toggle
	const aiToggle = document.getElementById('ai-toggle');
	const aiChat = document.getElementById('ai-chat');
	const chatMessages = document.getElementById('chat-messages');
	const chatInput = document.getElementById('chat-input');
	const sendBtn = document.getElementById('send-btn');
	const aiClose = document.getElementById('ai-close');


	aiToggle.addEventListener('click', () => {
		aiChat.style.display = aiChat.style.display === 'none' ? 'flex' : 'none';
	});

	aiClose.addEventListener('click', () => {
		aiChat.style.display = 'none';
	});

	sendBtn.addEventListener('click', () => {
		const msg = chatInput.value.trim();
		if(!msg) return;

		const userMsg = document.createElement('div');
		userMsg.textContent = "You: " + msg;
		userMsg.style.textAlign = "right";
		userMsg.style.marginBottom = "3px";
		chatMessages.appendChild(userMsg);
		chatInput.value = "";

		let reply = "";
		if(msg.toLowerCase().includes("concession")){
			reply = "Click on 'Apply for Concession' or check your history.";
		} else if(msg.toLowerCase().includes("pass")){
			reply = "Your pass info is visible under 'Current Pass'.";
		} else {
			reply = "I can help! Ask about concessions, pass details, or dashboard features.";
		}

		const botMsg = document.createElement('div');
		botMsg.textContent = "Assistant: " + reply;
		botMsg.style.textAlign = "left";
		botMsg.style.fontStyle = "italic";
		botMsg.style.marginBottom = "3px";
		chatMessages.appendChild(botMsg);

		chatMessages.scrollTop = chatMessages.scrollHeight;
	});

	
</script>

{% endblock %}
