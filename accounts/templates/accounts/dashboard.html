{% extends 'accounts/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
	body, html {
		height: 100%;
		margin: 0;
		background: url('/static/images/dashboard-bg.jpg') no-repeat center center fixed;
		background-size: cover;
		font-family: Arial, sans-serif;
	}

	.dashboard {
		padding: 30px;
		min-height: 100vh;
		border-radius: 12px;
		/* remove the transparent background */
	}
	/* Navigation Cards */
	.nav-cards {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 20px;
		margin-bottom: 30px;
	}
	.nav-card {
		background: rgba(255, 255, 255, 0.9);
		border-radius: 12px;
		padding: 20px;
		text-align: center;
		box-shadow: 0 3px 6px rgba(0,0,0,0.1);
		cursor: pointer;
		transition: transform 0.2s, box-shadow 0.2s;
	}
	.nav-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 6px 12px rgba(0,0,0,0.15);
		background: #e6f0ff; /* light blue */
	}
	.nav-card.active {
		border: 2px solid #0984e3;
	}

	.module-card {
		background: rgba(255, 255, 255, 0.95);
		border-radius: 12px;
		padding: 20px;
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		margin-bottom: 20px;
	}
</style>

<div class="dashboard">
	<div class="d-flex justify-content-between align-items-center mb-4" style="color:lavender; padding:10px; border-radius:8px;">
		<h2>Welcome, {{ user.username }} to Pass-Mate üëã</h2>
		<a href="{% url 'logout' %}" class="btn btn-danger btn-sm">Logout</a>
	</div>

	<!-- Navigation Cards -->
	<div class="nav-cards" id="moduleTabs">
		<div class="nav-card active" data-target="home">üè† Home</div>

		{% if user.role == "student" %}
			<div class="nav-card" data-target="concession">üìù Apply for Concession</div>
			<div class="nav-card" data-target="current">üéü Current Pass</div>
			<div class="nav-card" data-target="concessions">üìä Concession History</div>
		{% elif user.role == "admin" %}
			<div class="nav-card" data-target="verify">‚úÖ Verify Concessions</div>
			<div class="nav-card" data-target="manage">üë• Manage Students</div>
		{% elif user.role == "transporter" %}
			<div class="nav-card" data-target="pending">‚è≥ Pending Passes</div>
			<div class="nav-card" data-target="issued">üéü Issued Passes</div>
			<div class="nav-card" data-target="reports">üìë Reports</div>
		{% endif %}
	</div>

	<!-- Module Content -->
	<div id="moduleContent">
		<!-- Home -->
		<div class="module module-card" id="home">
			<h4>Dashboard Overview</h4>
			<p class="text-muted">Select an option above to get started.</p>
		</div>

		{% if user.role == "student" %}
			<div class="module module-card d-none" id="concession">
				<h4 class="text-center">Apply for Concession</h4>
				{% if active_pass_exists %}
					<div class="alert alert-warning text-center">
						üö® You already have an active pass.
					</div>
				{% elif pending_exists %}
  					<div class="alert alert-warning">‚è≥ Your concession application is pending.</div>
				{% else %}
					{% include 'concession_form.html' %}
				{% endif %}
			</div>

			<div class="module module-card d-none" id="current">
				<h4>Current Pass</h4>
				{% if active_pass_exists %}
					<a href="{% url 'show_pass' %}" class="btn btn-success w-100">View My E-Pass</a>
				{% else %}
					<button class="btn btn-secondary w-100" disabled>No Active Pass</button>
				{% endif %}
			</div>

			<div class="module module-card d-none" id="concessions">
				<h4>Concession History</h4>
				<p>Total concessions: {{ concessions_taken }}</p>
				{% if concessions_list %}
					<div class="row mt-4">
						{% for concession in concessions_list %}
							<div class="col-md-6 mb-3">
								<div class="card p-3 shadow-sm {% if concession.is_active == 0 %}bg-light{% else %}bg-white{% endif %}" style="border-radius: 12px;">
									<strong>Name:</strong> {{ concession.s_name }}<br>
									<strong>Department:</strong> {{ concession.department }}<br>
									<strong>Destination:</strong> {{ concession.destination }}<br>
									<strong>Duration:</strong> {{ concession.duration }} month(s)<br>
									<strong>Status:</strong> {{ concession.status }}<br>
									<strong>Applied On:</strong> {{ concession.b_date }}<br>
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}
					<div class="mt-4 card p-3 shadow-sm" style="border-radius: 12px;">No concession applications found.</div>
				{% endif %}
			</div>
		{% elif user.role == "admin" %}
			<div class="module module-card d-none" id="verify">
				<h4>Verify Concessions</h4>
				{% if pending_concessions %}
					<table class="table table-striped table-bordered mt-3">
						<thead class="table-dark">
							<tr>
								<th>Student</th>
								<th>Department</th>
								<th>Destination</th>
								<th>Duration</th>
								<th>Applied On</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for concession in pending_concessions %}
								<tr>
									<td>{{ concession.s_name }}</td>
									<td>{{ concession.department }}</td>
									<td>{{ concession.destination }}</td>
									<td>{{ concession.duration }} month(s)</td>
									<td>{{ concession.b_date }}</td>
									<td>
										<form method="post" action="{% url 'approve_concession' concession.id %}" style="display:inline;">
											{% csrf_token %}
											{% if concession.status == "Approved" %}
												<span data-bs-toggle="tooltip" data-bs-placement="top" title="Already Approved">
													<button type="button" class="btn btn-success btn-sm" disabled>Approve</button>
												</span>
											{% else %}
												<button type="submit" class="btn btn-success btn-sm">Approve</button>
											{% endif %}
										</form>
										<form method="post" action="{% url 'reject_concession' concession.id %}" style="display:inline;">
											{% csrf_token %}
											<button type="submit" class="btn btn-danger btn-sm">Reject</button>
										</form>
										<form method="post" action="{% url 'verify_concession' concession.id %}" style="display:inline;">
											{% csrf_token %}
											{% if concession.status != "Pending" %}
												<span data-bs-toggle="tooltip" data-bs-placement="top" title="Already Verified">
													<button type="button" class="btn btn-warning btn-sm" disabled>Verify</button>
												</span>
											{% else %}
												<button type="submit" class="btn btn-warning btn-sm">Verify</button>
											{% endif %}
										</form>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% else %}
					<div class="alert alert-info mt-3">‚úÖ No pending concessions.</div>
				{% endif %}
			</div>
		{% elif user.role == "transporter" %}
			<div class="module module-card d-none" id="pending">
				{% include "pending_passes.html" %}
			</div>
			<div class="module module-card d-none" id="issued">
				{% include "issued_passes.html" %}
			</div>
			<div class="module module-card d-none" id="reports">
				<h4>Reports</h4>
				<p>Generate and download reports here.</p>
			</div>
		{% endif %}
	</div>

	<!-- AI Assistant (GLOBAL, outside modules) -->
	<button id="ai-toggle" style="
		position: fixed;
		bottom: 20px;
		right: 20px;
		background:#0984e3;
		color:white;
		border:none;
		border-radius:50%;
		width:55px;
		height:56px;
		font-size:31px;
		cursor:pointer;
		z-index: 11;
	">üí¨</button>

	<div id="ai-chat" style="
		display: none;
		position: fixed;
		bottom: 80px;
		right: 20px;
		width:280px;
		max-height:350px;
		background:white;
		border-radius:10px;
		box-shadow:0 4px 15px rgba(0,0,0,0.2);
		flex-direction: column;
		overflow: hidden;
		z-index: 10;
	">
		<div style="background:#0984e3; color:white; padding:8px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
			Pass Mate Assistant
			<button id="ai-close" style="background:transparent; border:none; color:white; font-size:18px; cursor:pointer;">&times;</button>
		</div>
		<div id="chat-messages" style="flex:1; padding:5px; overflow-y:auto;"></div>
		<div style="display:flex; border-top:1px solid #ccc;">
			<input id="chat-input" type="text" placeholder="Ask me..." style="flex:1; padding:5px; border:none;">
			<button id="send-btn" style="background:#0984e3; color:white; border:none; padding:5px 10px;">Send</button>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>

<script>
	// Module switching via nav cards
	const navCards = document.querySelectorAll('#moduleTabs .nav-card');
	const modules = document.querySelectorAll('#moduleContent .module');

	navCards.forEach(card => {
		card.addEventListener('click', () => {
			navCards.forEach(c => c.classList.remove('active'));
			card.classList.add('active');

			modules.forEach(m => m.classList.add('d-none'));
			const targetDiv = document.getElementById(card.dataset.target);
			if (targetDiv) {
				targetDiv.classList.remove('d-none');
			}
		});
	});

	// AI Assistant toggle
	const aiToggle = document.getElementById('ai-toggle');
	const aiChat = document.getElementById('ai-chat');
	const chatMessages = document.getElementById('chat-messages');
	const chatInput = document.getElementById('chat-input');
	const sendBtn = document.getElementById('send-btn');
	const aiClose = document.getElementById('ai-close');


	aiToggle.addEventListener('click', () => {
		aiChat.style.display = aiChat.style.display === 'none' ? 'flex' : 'none';
	});

	aiClose.addEventListener('click', () => {
		aiChat.style.display = 'none';
	});

	sendBtn.addEventListener('click', () => {
		const msg = chatInput.value.trim();
		if(!msg) return;

		const userMsg = document.createElement('div');
		userMsg.textContent = "You: " + msg;
		userMsg.style.textAlign = "right";
		userMsg.style.marginBottom = "3px";
		chatMessages.appendChild(userMsg);
		chatInput.value = "";

		let reply = "";
		if(msg.toLowerCase().includes("concession")){
			reply = "Click on 'Apply for Concession' or check your history.";
		} else if(msg.toLowerCase().includes("pass")){
			reply = "Your pass info is visible under 'Current Pass'.";
		} else {
			reply = "I can help! Ask about concessions, pass details, or dashboard features.";
		}

		const botMsg = document.createElement('div');
		botMsg.textContent = "Assistant: " + reply;
		botMsg.style.textAlign = "left";
		botMsg.style.fontStyle = "italic";
		botMsg.style.marginBottom = "3px";
		chatMessages.appendChild(botMsg);

		chatMessages.scrollTop = chatMessages.scrollHeight;
	});

	document.addEventListener("DOMContentLoaded", function () {
		const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	});
</script>
{% endblock %}
