{% extends 'accounts/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
	body, html {
		height: 100%;
		margin: 0;
	}
	.dashboard {
		display: flex;
		height: 100vh;
	}
	/* Sidebar */
	.sidebar {
		width: 250px;
		background-color: #343a40;
		color: #fff;
		padding: 20px;
	}
	.sidebar h4 {
		color: #f8f9fa;
		margin-bottom: 20px;
	}
	.sidebar .nav-link {
		color: #adb5bd;
		padding: 8px 0;
		display: block;
		text-decoration: none;
	}
	.sidebar .nav-link.active,
	.sidebar .nav-link:hover {
		color: #fff;
		font-weight: bold;
	}
	/* Main content */
	.main-content {
		flex-grow: 1;
		padding: 30px;
		background-color: #f1f3f6;
		overflow-y: auto;
	}
	.module-card {
		background: #fff;
		border-radius: 10px;
		padding: 20px;
		box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		margin-bottom: 20px;
	}
</style>

<div class="dashboard">
	<!-- Sidebar -->
	<div class="sidebar">
		<h4>Dashboard</h4>
		<ul class="nav flex-column" id="moduleTabs">

			<li><a class="nav-link active" href="#" data-target="home">Home</a></li>

			{% if user.role == "student" %}
				<li><a class="nav-link" href="#" data-target="concession">Apply for Concession</a></li>
				<li><a class="nav-link" href="#" data-target="pass">Apply for Pass</a></li>
				<li><a class="nav-link" href="#" data-target="current">Current Pass</a></li>
				<li><a class="nav-link" href="#" data-target="concessions">No. of Concessions Taken</a></li>
			{% elif user.role == "admin" %}
				<li><a class="nav-link" href="#" data-target="verify">Verify Concessions</a></li>
				<li><a class="nav-link" href="#" data-target="manage">Manage Students</a></li>
			{% elif user.role == "transporter" %}
				<li><a class="nav-link" href="#" data-target="issued">Issued Passes</a></li>
				<li><a class="nav-link" href="#" data-target="reports">Reports</a></li>
			{% endif %}
		</ul>
	</div>

	<!-- Main content -->
	<div class="main-content">
		<div class="d-flex justify-content-between align-items-center mb-4">
			<h2>Welcome, {{ user.username }} ðŸ‘‹</h2>
			<a href="{% url 'logout' %}" class="btn btn-danger btn-sm">Logout</a>
		</div>

		<div id="moduleContent">
			<!-- Home -->
			<div class="module module-card" id="home">
				<p class="text-muted">Use the sidebar to access your modules.</p>
			</div>

			{% if user.role == "student" %}
				<!-- Apply for Concession -->
				<div class="module module-card d-none" id="concession">
					<h4 class="text-center">Apply for Concession</h4>
					{% if active_pass_exists %}
					<div class="alert alert-warning text-center">
						ðŸš¨ You already have an active pass. You cannot apply for another until it expires.
					</div>
					{% else %}
						{% include 'concession_form.html' %}
					{% endif %}
				</div>

				<!-- Apply for Pass -->
				<div class="module module-card d-none" id="pass">
					<h4>Apply for Pass</h4>
					<p class="mb-2"><strong>Instructions for Applying for a Railway Pass:</strong></p>
					<ul>
						<li>Ensure you have an active concession approved before applying.</li>
						<li>Fill in all required details accurately.</li>
						<li>Upload a recent passport-size photograph if required.</li>
						<li>Verify your details before submitting.</li>
						<li>Your application will be reviewed by the authority.</li>
					</ul>
				</div>

				<!-- Current Pass -->
				<div class="module module-card d-none" id="current">
					<h4>Current Pass</h4>
					<a href="{% url 'show_pass' %}" class="btn btn-success">View My E-Pass</a>
				</div>
				
				<!-- Concessions Taken -->
				<div class="module module-card d-none" id="concessions">
					<h4>No. of Concessions Taken</h4>
					<p>Total concessions taken: {{ concessions_taken }}</p>

					{% if concessions_list %}
					<div class="row mt-4">
						{% for concession in concessions_list %}
						<div class="col-md-6 mb-3">
							<div class="card p-3 shadow-sm {% if concession.is_active == 0 %}bg-light{% else %}bg-white{% endif %}" style="border-radius: 12px;">
								<strong>Name:</strong> {{ concession.s_name }}<br>
								<strong>Department:</strong> {{ concession.department }}<br>
								<strong>Destination:</strong> {{ concession.destination }}<br>
								<strong>Duration:</strong> {{ concession.duration }} month(s)<br>
								<strong>Status:</strong> {{ concession.status }}<br>
								<strong>Applied On:</strong> {{ concession.b_date }}<br>
							</div>
						</div>
						{% endfor %}
					</div>
					{% else %}
					<div class="mt-4 card p-3 shadow-sm" style="border-radius: 12px;">No concession applications found.</div>
					{% endif %}
				</div>
			{% elif user.role == "admin" %}
				<!-- Verify Concessions start-->
				<div class="module module-card d-none" id="verify">
					<h4>Verify Concessions</h4>

					{% if pending_concessions %}
					<table class="table table-striped table-bordered mt-3">
						<thead class="table-dark">
							<tr>
								<th>Student Name</th>
								<th>Department</th>
								<th>Destination</th>
								<th>Duration</th>
								<th>Applied On</th>
								<th>Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for concession in pending_concessions %}
							<tr>
								<td>{{ concession.s_name }}</td>
								<td>{{ concession.department }}</td>
								<td>{{ concession.destination }}</td>
								<td>{{ concession.duration }} month(s)</td>
								<td>{{ concession.b_date }}</td>
								<td>
									<form method="post" action="{% url 'approve_concession' concession.id %}" style="display:inline;">
										{% csrf_token %}
										<button type="submit" class="btn btn-success btn-sm">Approve</button>
									</form>
									<form method="post" action="{% url 'reject_concession' concession.id %}" style="display:inline;">
										{% csrf_token %}
										<button type="submit" class="btn btn-danger btn-sm">Reject</button>
									</form>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
					{% else %}
					<div class="alert alert-info mt-3">âœ… No pending concessions right now.</div>
					{% endif %}
				</div>
				<!-- Verify Concessions end-->
			{% elif user.role == "transporter" %}
				<!-- Issued Passes -->
				<div class="module module-card d-none" id="issued">
					<h4>Issued Passes</h4>
					<p>Transporter can view all issued passes.</p>
				</div>
				<!-- Reports -->
				<div class="module module-card d-none" id="reports">
					<h4>Reports</h4>
					<p>Generate and download reports here.</p>
				</div>
			{% endif %}
		</div>
	</div>
</div>

<script>
	const links = document.querySelectorAll('#moduleTabs .nav-link');
	const modules = document.querySelectorAll('#moduleContent .module');

	links.forEach(link => {
		link.addEventListener('click', function(e) {
			e.preventDefault();
			links.forEach(l => l.classList.remove('active'));
			this.classList.add('active');

			modules.forEach(m => m.classList.add('d-none'));
			const target = this.dataset.target;
			const targetDiv = document.getElementById(target);
			if (targetDiv) {
				targetDiv.classList.remove('d-none');
			}
		});
	});
</script>
{% endblock %}
